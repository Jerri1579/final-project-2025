import sqlite3

SCHEMA = """
-- artists
CREATE TABLE artists (
    artist_id TEXT PRIMARY KEY,
    name TEXT UNIQUE,
    genre TEXT,
    followers INTEGER
);

-- tracks
CREATE TABLE tracks (
    track_id TEXT PRIMARY KEY,
    artist_id TEXT,
    track_name TEXT,
    album_name TEXT,
    release_year INTEGER,
    FOREIGN KEY(artist_id) REFERENCES artists(artist_id)
);

-- features
CREATE TABLE features (
    track_id TEXT PRIMARY KEY,
    danceability REAL,
    energy REAL,
    tempo REAL,
    valence REAL,
    FOREIGN KEY(track_id) REFERENCES tracks(track_id)
);

-- last.fm
CREATE TABLE lastfm (
    track_id TEXT PRIMARY KEY,
    playcount INTEGER,
    listeners INTEGER,
    top_tag TEXT,
    FOREIGN KEY(track_id) REFERENCES tracks(track_id)
);
"""

import requests
import time
import base64

def get_spotify_token(client_id, client_secret):
    # Input:
    #   client_id (str)
    #   client_secret (str)
    # Output:
    #   token (str) - Bearer access token
    url = "https://accounts.spotify.com/api/token"
    auth_str = f"{client_id}:{client_secret}"
    b64_auth = base64.b64encode(auth_str.encode('ascii')).decode('ascii')
    headers = {'Authorization': 'Basic ' + b64_auth}
    data = {'grant_type': 'client_credentials'}
    auth_response = requests.post(url, data=data, headers=headers)
    auth_response.raise_for_status()
    return auth_response.json().get('access_token')

# function to get Spotify API token

def get_spotify_tracks(query, token, limit=25):
    # Input:
    #   query (str) - Search query
    #   token (str) - Bearer access token
    #   limit (int) - Number of results to return
    # Output:
    #   tracks (list) - List of track dictionaries
    headers = {"Authorization": f"Bearer {token}"}
    url = "https://api.spotify.com/v1/search"
    params = {
        "q": query,
        "type": "track",
        "limit": min(limit, 25)
    }

    response = requests.get(url, headers=headers, params=params).json()

    tracks = []
    for item in response["tracks"]["items"]:
        album = item["album"]
        year = int(album["release_date"].split("-")[0])
        artist = item["artists"][0]

        tracks.append({
            "track_id": item["id"],
            "track_name": item["name"],
            "artist_name": artist["name"],
            "artist_id": artist["id"],
            "album_name": album["name"],
            "release_year": year,
            "primary_genre": None
        })
    return tracks


def store_spotify_data(cursor, track_list, feature_list):
    """
    Insert data into:
      - tracks
      - artists
      - audio_features
    """
    for t in track_list:
        cursor.execute("""
            INSERT OR IGNORE INTO artists (artist_id, name)
            VALUES (?, ?)
        """, (t["artist_id"], t["artist"]))

        cursor.execute("""
            INSERT OR REPLACE INTO tracks (track_id, name, artist_id, release_year)
            VALUES (?, ?, ?, ?)
        """, (t["id"], t["name"], t["artist_id"], t["release_year"]))

    for f in feature_list:
        cursor.execute("""
            INSERT OR REPLACE INTO audio_features
            (track_id, danceability, energy, tempo)
            VALUES (?, ?, ?, ?)
        """, (f["id"], f["danceability"], f["energy"], f["tempo"]))

#function to search for tracks

